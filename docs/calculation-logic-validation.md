# Coast FIRE 計算ロジック妥当性調査レポート

## 目次

1. [調査概要](#調査概要)
2. [Coast FIREの概念](#coast-fireの概念)
3. [計算ロジックの詳細分析](#計算ロジックの詳細分析)
4. [数学的妥当性の検証](#数学的妥当性の検証)
5. [実装の正確性評価](#実装の正確性評価)
6. [テストカバレッジの評価](#テストカバレッジの評価)
7. [エッジケースとバリデーション](#エッジケースとバリデーション)
8. [総合評価](#総合評価)
9. [改善提案](#改善提案)

## 調査概要

### 調査日時

2026年2月15日

### 調査対象

- ファイル: `lib/coastFireCalculations.ts`
- テストファイル: `__tests__/lib/coastFireCalculations.test.ts`

### 調査目的

Coast FIREの計算ロジックが、財務計画の理論的基盤に基づいて正確に実装されているかを検証する。

## Coast FIREの概念

### 定義

Coast FIRE（Coast Financial Independence, Retire Early）は、FIRE（経済的自立と早期退職）の一形態で、以下の特徴を持つ：

1. **現時点で一定額の資産を確保**する
2. **追加投資を行わず**、複利運用のみで資産を増やす
3. **目標年齢（通常は退職年齢）に目標資産額を達成**する

### 基本的な考え方

- 若い時期に必要な資産を確保すれば、複利の力で自然に資産が増える
- 追加投資の負担なく、仕事の選択肢を広げることができる
- 「Coast」は「惰性で進む」という意味で、資産が自動的に増えることを表す

## 計算ロジックの詳細分析

### 1. 入力パラメータ

```typescript
interface CoastFireInput {
    targetAmount: number;      // 目標資産額（万円）- 現在価値ベース
    targetAge: number;         // 目標達成年齢
    currentAge: number;        // 現在の年齢
    returnRate: number;        // 運用利回り（小数、例: 0.05 = 5%）
    inflationRate: number;     // インフレ率（小数、例: 0.02 = 2%）
}
```

**重要な設計判断:**

- `targetAmount`は**現在価値ベース**（今の物価感での必要額）
- これにより、ユーザーは「今の感覚で○○万円必要」と入力できる

### 2. 核心的な計算式

#### 2.1 実質利回りの計算（フィッシャー方程式）

```typescript
const realReturnRate = (1 + returnRate) / (1 + inflationRate) - 1;
```

**数学的背景:**

フィッシャー方程式は、名目利回りと実質利回りの関係を表す：

```
1 + 名目利回り = (1 + 実質利回り) × (1 + インフレ率)
```

これを変形すると：

```
実質利回り = (1 + 名目利回り) / (1 + インフレ率) - 1
```

**例:**

- 運用利回り（名目）= 5% (0.05)
- インフレ率 = 2% (0.02)
- 実質利回り = 1.05 / 1.02 - 1 ≈ 0.0294 = 2.94%

**妥当性評価:** ✅ **正確**

- フィッシャー方程式の厳密な形式を使用
- 近似式 `returnRate - inflationRate` ではなく、正確な除算を使用
- これにより、高インフレ・高利回り環境でも正確

#### 2.2 現在必要な資産額の計算

```typescript
const requiredAmount = targetAmount / Math.pow(1 + realReturnRate, investmentYears);
```

**数学的背景:**

現在価値の計算式：

```
PV = FV / (1 + r)^n
```

ここで：

- PV (Present Value) = 現在必要な資産額
- FV (Future Value) = 目標資産額（現在価値ベース）
- r = 実質利回り
- n = 運用年数

**重要なポイント:**

1. `targetAmount`は既に現在価値なので、実質利回りを使って割り引く
2. 名目利回りではなく実質利回りを使うことで、インフレを正しく考慮

**妥当性評価:** ✅ **正確**

- 標準的な現在価値の計算式を正しく実装
- 実質利回りを使用することで、インフレ調整が適切に行われる

#### 2.3 目標年齢時点での名目資産額

```typescript
const targetNominalAmount = requiredAmount * Math.pow(1 + returnRate, investmentYears);
```

**数学的背景:**

将来価値の計算式：

```
FV = PV × (1 + r)^n
```

ここで：

- FV = 将来の名目資産額
- PV = 現在の資産額
- r = 名目運用利回り
- n = 運用年数

**検証計算:**

目標年齢時点での実質価値を計算すると：

```
targetNominalAmount / (1 + inflationRate)^investmentYears
= requiredAmount × (1 + returnRate)^n / (1 + inflationRate)^n
= requiredAmount × [(1 + returnRate) / (1 + inflationRate)]^n
= requiredAmount × (1 + realReturnRate)^n
= targetAmount  // 元の目標額に一致！
```

**妥当性評価:** ✅ **正確**

- 名目利回りを使った将来価値計算
- インフレ調整後の実質価値が目標額と一致する

### 3. 年齢ごとのデータ計算

```typescript
for (let age = currentAge; age <= targetAge; age++) {
    const yearsElapsed = age - currentAge;
    
    // 各年の資産額（名目）
    const amount = requiredAmount * Math.pow(1 + returnRate, yearsElapsed);
    
    // インフレ調整後価値（実質）
    const inflationAdjusted = amount / Math.pow(1 + inflationRate, yearsElapsed);
    
    // 実質利回り累計（%）
    const realReturn = yearsElapsed === 0 ? 0 : ((inflationAdjusted / requiredAmount) - 1) * 100;
}
```

**各計算の妥当性:**

1. **名目資産額 (amount)**
    - 複利計算の標準的な式
    - ✅ 正確

2. **インフレ調整後価値 (inflationAdjusted)**
    - 購買力ベースの実質価値
    - 数式: `名目額 / (1 + インフレ率)^年数`
    - ✅ 正確

3. **実質利回り累計 (realReturn)**
    - 開始時点からの累積実質リターン（パーセント表示）
    - 数式: `((現在の実質価値 / 開始時の実質価値) - 1) × 100`
    - ✅ 正確

## 数学的妥当性の検証

### 検証1: 基本ケース

**入力:**

- 目標資産額: 2000万円（現在価値）
- 現在年齢: 28歳
- 目標年齢: 65歳
- 運用利回り: 5%
- インフレ率: 2%

**手計算による検証:**

```
運用年数 = 65 - 28 = 37年
実質利回り = 1.05 / 1.02 - 1 = 0.0294117... ≈ 2.94%

現在必要な資産額 = 2000 / (1.0294117)^37
                = 2000 / 2.923...
                ≈ 684万円

目標年齢での名目額 = 684 × (1.05)^37
                  = 684 × 6.081...
                  ≈ 4,161万円

目標年齢での実質価値 = 4,161 / (1.02)^37
                    = 4,161 / 2.081
                    ≈ 2,000万円 ✅
```

**実装の結果との比較:**

- テストコードでは `requiredAmount` が600〜800万円の範囲内と検証
- 手計算の約684万円は範囲内 ✅
- 最終的な実質価値が目標額2000万円と一致することも検証済み ✅

### 検証2: 極端なケース（運用利回り = インフレ率）

**理論:**
運用利回りとインフレ率が同じ場合、実質的な資産の増加はない。
よって、必要な資産額 = 目標資産額となるはず。

**実装の検証（テストコードより）:**

```typescript
const input = {
    returnRate: 0.03,
    inflationRate: 0.03,
    // ... その他のパラメータ
};
const result = calculateCoastFire(input);
// 実質利回りが0に非常に近い
// requiredAmountが目標額2000に近い ✅
```

### 検証3: インフレ率0のケース

**理論:**
インフレがない場合、名目額 = 実質価値となる。

**実装の検証（テストコードより）:**

```typescript
const input = {
    inflationRate: 0,
    // ... その他のパラメータ
};
const result = calculateCoastFire(input);
// 全ての年齢で amount ≈ inflationAdjusted ✅
```

## 実装の正確性評価

### 強み

1. **フィッシャー方程式の正確な実装**
    - 近似ではなく厳密な式を使用
    - 高インフレ環境でも正確

2. **現在価値ベースの設計**
    - ユーザーフレンドリー
    - 「今の感覚での必要額」を入力できる

3. **実質と名目の明確な区別**
    - `amount`（名目）と `inflationAdjusted`（実質）を両方計算
    - ユーザーが両方の視点で資産を理解できる

4. **型安全性**
    - TypeScriptによる型定義
    - インターフェースで入出力を明確化

### 数値精度

JavaScript の `Number` 型は IEEE 754 倍精度浮動小数点数を使用：

- 精度: 約15〜17桁
- 金融計算には十分な精度
- ただし、非常に長期（100年以上）や極端な利回りでは誤差の累積に注意

**評価:** ✅ 本アプリケーションの用途（数十年、通常の利回り）では十分

## テストカバレッジの評価

### テストケース一覧

1. **基本的な計算の正確性**
    - 運用年数、実質利回り、必要資産額の検証
    - 年齢ごとのデータ配列の長さ検証
    - 最終年の実質価値が目標額と一致することを検証

2. **特殊ケースのテスト**
    - インフレ率0の場合
    - 運用利回りとインフレ率が同じ場合
    - 短期間（5年）の計算

3. **パラメータ感度テスト**
    - 運用利回りを変更した場合の影響確認

4. **包括的なバリデーションテスト**
    - 目標資産額（正の値、範囲チェック）
    - 年齢（範囲チェック、大小関係）
    - 運用利回り（範囲チェック）
    - インフレ率（範囲チェック）
    - NaN / Infinity のチェック

### カバレッジ評価

**テスト実行結果:** 全テスト合格 ✅

**カバレッジの質:**

- ✅ 主要な計算パスを網羅
- ✅ エッジケースを考慮
- ✅ バリデーションを徹底的にテスト
- ✅ 数学的な正確性を検証

**評価:** 優れたテストカバレッジ

## エッジケースとバリデーション

### バリデーションの妥当性

1. **目標資産額: 100万円〜10億円**
    - ✅ 妥当な範囲
    - 個人の資産計画として現実的

2. **現在の年齢: 0歳〜99歳**
    - ✅ 妥当
    - 親が子供のために計画する場合も対応

3. **目標達成年齢: 30歳〜100歳**
    - ✅ 妥当
    - 早期リタイアから長寿まで対応

4. **運用利回り: 0%〜20%**
    - ✅ 妥当
    - 保守的な債券投資（低め）から積極的な株式投資（高め）まで対応
    - 20%超は非現実的なので制限は適切

5. **インフレ率: 0%〜10%**
    - ✅ 妥当
    - 先進国の通常のインフレから高インフレまで対応

### 潜在的なエッジケース

#### 1. 実質利回りがマイナスになる場合

**ケース:** インフレ率 > 運用利回り

**例:**

- 運用利回り: 3%
- インフレ率: 5%
- 実質利回り: (1.03 / 1.05 - 1) ≈ -1.9%

**現在の実装の動作:**

```typescript
const realReturnRate = (1 + 0.03) / (1 + 0.05) - 1;  // ≈ -0.019
const requiredAmount = 2000 / Math.pow(1 + (-0.019), 37);
                     = 2000 / Math.pow(0.981, 37);
                     = 2000 / 0.483;
                     ≈ 4,140万円
```

**評価:** ✅ 数学的に正しい

- 実質利回りがマイナスの場合、より多くの初期資産が必要
- 実装は正しく動作する

#### 2. 非常に長期の運用（70年以上）

**ケース:** 現在年齢0歳、目標年齢100歳

**評価:** ✅ 動作するが、以下の注意点あり

- 浮動小数点の誤差が累積する可能性
- ただし、金融計画としての精度は保たれる

#### 3. ゼロに近い実質利回り

**ケース:** 運用利回り ≈ インフレ率

**評価:** ✅ テストで検証済み

- 実装は正しく動作

## 総合評価

### ✅ 優れている点

1. **数学的正確性**
    - フィッシャー方程式の厳密な実装
    - 現在価値・将来価値の標準的な計算式を使用
    - インフレ調整の正確な処理

2. **設計の優秀さ**
    - 現在価値ベースの入力（ユーザーフレンドリー）
    - 実質と名目の両方を計算（理解しやすい）
    - 型安全性（TypeScript）

3. **実装品質**
    - クリーンなコード
    - 適切なコメント
    - 包括的なバリデーション

4. **テスト品質**
    - 高いカバレッジ
    - エッジケースの考慮
    - 数学的検証

### ⚠️ 注意点・制限事項

1. **浮動小数点精度**
    - 極端に長期（100年超）や極端な利回りでは誤差の累積の可能性
    - **評価:** 通常の使用範囲では問題なし

2. **複利計算の前提**
    - 毎年複利が適用される前提
    - 実際の運用では手数料や税金が発生
    - **評価:** 理論値計算ツールとしては適切

3. **定率の前提**
    - 運用利回りとインフレ率が毎年一定の前提
    - 実際には変動する
    - **評価:** 計画ツールとしては標準的なアプローチ

## 改善提案

### 優先度: 低（現状で十分に機能的）

#### 1. 数値精度の明示

**提案:**
ドキュメントまたはUIに以下を追加：

- 「計算結果は理論値であり、実際の運用では手数料や税金を考慮する必要があります」
- 「運用利回りとインフレ率は一定と仮定しています」

**理由:** ユーザーの理解を深める

#### 2. 追加のシナリオ分析機能

**提案（将来の機能拡張として）:**

- 楽観的・悲観的シナリオの表示
- モンテカルロシミュレーション

**理由:** より堅実な計画立案が可能

#### 3. 税金・手数料の考慮

**提案（将来の機能拡張として）:**

- 税金控除後の実効利回りの計算オプション
- 運用手数料の考慮

**理由:** より実用的な計画

### 優先度: 極低（必須ではない）

#### 4. 年複利以外の複利頻度

**提案:**

- 月次複利、四半期複利などのオプション

**理由:** より精密な計算（ただし、差は微小）

## 結論

### 妥当性評価: ✅ **適切**

Coast FIREの計算ロジックは、以下の点で**高い妥当性**を持つ：

1. **数学的正確性**: フィッシャー方程式と現在価値計算の正確な実装
2. **設計の優秀さ**: ユーザーフレンドリーで理解しやすい設計
3. **実装品質**: クリーンで保守性の高いコード
4. **テスト品質**: 包括的なテストによる信頼性の担保

### 推奨事項

1. **現状維持**: 現在の実装は十分に正確で実用的
2. **ドキュメント強化**: 前提条件と制限事項の明示（低優先度）
3. **将来の拡張**: シナリオ分析や税金考慮は将来的な機能拡張として検討可能

### 最終評価

**Coast FIREの計算ロジックは、財務計画ツールとして適切であり、実用に供するに足る品質を備えている。**

---

## 参考文献

### 数学的概念

- Fisher, I. (1930). "The Theory of Interest"（フィッシャー方程式の原典）
- 時間価値（Time Value of Money）の標準的な金融数学

### Coast FIRE の概念

- FIRE（Financial Independence, Retire Early）ムーブメントの派生概念
- 複利運用と早期リタイアの組み合わせ

### 実装技術

- TypeScript Type System
- JavaScript IEEE 754 浮動小数点演算
- Jest Testing Framework

---

**調査実施者:** GitHub Copilot  
**調査日:** 2026年2月15日  
**レポートバージョン:** 1.0
